# 위치 기반 정렬 기능 설정 가이드

## 📋 개요
메인 페이지의 "가까운순" 정렬 기능을 위한 설정 가이드입니다.

## 🔧 필요한 설정

### 1. 환경 변수 설정
`.env.local` 파일에 다음 환경 변수를 추가하세요:

```env
# 카카오맵 API 키 (주소 변환용)
NEXT_PUBLIC_KAKAO_MAP_API_KEY=your_kakao_map_api_key_here
```

### 2. 데이터베이스 함수 생성
다음 SQL 파일을 Supabase에서 실행하세요:

```sql
-- sql/20250922-03_add_distance_calculation_function.sql
```

### 3. 카카오맵 API 키 발급
1. [카카오 개발자 콘솔](https://developers.kakao.com/) 접속
2. 애플리케이션 생성 또는 기존 애플리케이션 선택
3. "플랫폼" → "Web" → "사이트 도메인" 등록
4. "앱 키" → "JavaScript 키" 복사
5. `.env.local`에 `NEXT_PUBLIC_KAKAO_MAP_API_KEY`로 설정

## 🚀 기능 동작 방식

### 1. 로그인 체크
- "가까운순" 클릭 시 로그인 상태 확인
- 미로그인 시 다이얼로그 표시 후 로그인 페이지로 이동

### 2. 위치 정보 수집
- 브라우저의 `navigator.geolocation` API 사용
- 사용자 위치 권한 요청
- 고정밀도 위치 정보 수집

### 3. 주소 변환
- 카카오맵 API를 사용하여 좌표 → 주소 변환
- 변환된 주소를 다이얼로그에 표시

### 4. 거리 기반 정렬
- Haversine 공식을 사용한 거리 계산
- 출발지 기준으로 거리순 정렬
- PostCard에 거리 정보 표시

## 📱 사용자 경험

### 로그인 미완료 시
```
[가까운순 클릭] → [로그인 다이얼로그] → [로그인 페이지 이동]
```

### 로그인 완료 시
```
[가까운순 클릭] → [위치 다이얼로그] → [위치 수집] → [주소 표시] → [검색 버튼] → [거리순 정렬]
```

## 🔍 API 엔드포인트

### POST `/api/posts/sort-by-distance`
거리 기반 정렬을 위한 API

**요청:**
```json
{
  "latitude": 37.5665,
  "longitude": 126.9780,
  "page": 1,
  "limit": 10
}
```

**응답:**
```json
{
  "success": true,
  "posts": [...],
  "pagination": {
    "page": 1,
    "limit": 10,
    "hasMore": true
  }
}
```

## 🛠️ 문제 해결

### 위치 권한 거부 시
- 브라우저 설정에서 위치 권한 허용 필요
- HTTPS 환경에서만 위치 API 사용 가능

### 카카오맵 API 오류 시
- API 키 확인
- 도메인 등록 확인
- 일일 호출 한도 확인

### 거리 계산 오류 시
- 데이터베이스에 위경도 정보가 있는지 확인
- SQL 함수가 정상적으로 생성되었는지 확인

## 📊 성능 고려사항

- 위치 정보는 5분간 캐시
- 거리 계산은 서버에서 수행
- 페이지네이션으로 성능 최적화
- 무한 스크롤 지원
