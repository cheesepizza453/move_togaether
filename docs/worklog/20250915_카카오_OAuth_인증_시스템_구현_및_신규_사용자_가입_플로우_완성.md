# 2025ë…„ 9ì›” 15ì¼ - ì¹´ì¹´ì˜¤ OAuth ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„ ë° ì‹ ê·œ ì‚¬ìš©ì ê°€ì… í”Œë¡œìš° ì™„ì„±

## ğŸ“‹ ì‘ì—… ê°œìš”

ì¹´ì¹´ì˜¤ OAuth ì¸ì¦ ì‹œìŠ¤í…œì„ Supabaseì™€ ì—°ë™í•˜ì—¬ êµ¬í˜„í•˜ê³ , ì‹ ê·œ ì‚¬ìš©ìì˜ ì¶”ê°€ ì •ë³´ ì…ë ¥ í”Œë¡œìš°ë¥¼ ì™„ì„±í–ˆìŠµë‹ˆë‹¤. ê¸°ì¡´ì˜ ìˆ˜ë™ API ë°©ì‹ì—ì„œ Supabaseì˜ í‘œì¤€ OAuth í”Œë¡œìš°ë¡œ ì „í™˜í•˜ì—¬ ì•ˆì •ì„±ê³¼ ì‚¬ìš©ì ê²½í—˜ì„ í¬ê²Œ í–¥ìƒì‹œì¼°ìŠµë‹ˆë‹¤.

## ğŸ¯ ì£¼ìš” ì„±ê³¼

### 1. Supabase OAuth í†µí•©
- **ê¸°ì¡´ ë°©ì‹**: ìˆ˜ë™ ì¹´ì¹´ì˜¤ API í˜¸ì¶œ + ì„œë²„ API ì²˜ë¦¬
- **ìƒˆë¡œìš´ ë°©ì‹**: Supabase OAuth + í´ë¼ì´ì–¸íŠ¸ ì§ì ‘ í”„ë¡œí•„ ìƒì„±
- **ì¥ì **: í‘œì¤€ OAuth í”Œë¡œìš°, ì•ˆì •ì„± í–¥ìƒ, ì½”ë“œ ê°„ì†Œí™”

### 2. ì‹ ê·œ ì‚¬ìš©ì ê°€ì… í”Œë¡œìš° ì™„ì„±
- **ë¬¸ì œ**: ì‹ ê·œ ì‚¬ìš©ìê°€ ì¶”ê°€ ì •ë³´ ì…ë ¥ í˜ì´ì§€ì—ì„œ ìë™ìœ¼ë¡œ ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë¨
- **í•´ê²°**: `isNewUser` ìƒíƒœ ê´€ë¦¬ë¡œ ì‹ ê·œ ì‚¬ìš©ìì™€ ê¸°ì¡´ ì‚¬ìš©ì êµ¬ë¶„
- **ê²°ê³¼**: ì‹ ê·œ ì‚¬ìš©ìëŠ” ì•ˆì •ì ìœ¼ë¡œ ì¶”ê°€ ì •ë³´ë¥¼ ì…ë ¥í•  ìˆ˜ ìˆìŒ

### 3. í”„ë¡œí•„ ìƒì„± ì‹œìŠ¤í…œ ê°œì„ 
- **ë¬¸ì œ**: API í˜¸ì¶œ ë°©ì‹ì—ì„œ RLS ì •ì±… ìœ„ë°˜ ë° íƒ€ì„ì•„ì›ƒ ë°œìƒ
- **í•´ê²°**: í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì§ì ‘ Supabase í…Œì´ë¸”ì— INSERT
- **ê²°ê³¼**: ì•ˆì •ì ì¸ í”„ë¡œí•„ ìƒì„± ë° ì—ëŸ¬ ì²˜ë¦¬

## ğŸ”§ ê¸°ìˆ ì  êµ¬í˜„

### 1. ì¹´ì¹´ì˜¤ OAuth í”Œë¡œìš°

```mermaid
graph TD
    A["ì‚¬ìš©ìê°€ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­"] --> B["supabase.auth.signInWithOAuth í˜¸ì¶œ"]
    B --> C["ì¹´ì¹´ì˜¤ ì¸ì¦ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸"]
    C --> D["ì‚¬ìš©ìê°€ ì¹´ì¹´ì˜¤ì—ì„œ ì¸ì¦"]
    D --> E["Supabase ì½œë°± URLë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸"]
    E --> F["signup/kakao í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸"]
    F --> G["OAuth ì½œë°± ì²˜ë¦¬ ì‹œì‘"]
    G --> H{"ê¸°ì¡´ ì‚¬ìš©ì?"}
    H -->|Yes| I["ë°”ë¡œ ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™"]
    H -->|No| J["ì‹ ê·œ ì‚¬ìš©ì í”Œë˜ê·¸ ì„¤ì •"]
    J --> K["ì¶”ê°€ ì •ë³´ ì…ë ¥ í¼ í‘œì‹œ"]
    K --> L["ì‚¬ìš©ìê°€ í¼ ì‘ì„± í›„ ì œì¶œ"]
    L --> M["í”„ë¡œí•„ ìƒì„±"]
    M --> N["ë¡œê·¸ì•„ì›ƒ í›„ ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™"]
```

### 2. ì‹ ê·œ ì‚¬ìš©ì ìƒíƒœ ê´€ë¦¬

```mermaid
stateDiagram-v2
    [*] --> OAuthStart
    OAuthStart --> UserAuth
    UserAuth --> ProfileCheck
    ProfileCheck --> ExistingUser: í”„ë¡œí•„ ì¡´ì¬
    ProfileCheck --> NewUser: í”„ë¡œí•„ ì—†ìŒ
    NewUser --> AdditionalInfo
    AdditionalInfo --> ProfileCreate
    ProfileCreate --> SignupComplete
    ExistingUser --> LoginComplete
    SignupComplete --> [*]
    LoginComplete --> [*]
```

### 3. ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°

```mermaid
graph TB
    A["login/page.jsx"] --> B["supabase.auth.signInWithOAuth"]
    B --> C["ì¹´ì¹´ì˜¤ OAuth"]
    C --> D["signup/kakao/page.jsx"]
    D --> E["OAuth ì½œë°± ì²˜ë¦¬"]
    E --> F{"ì‚¬ìš©ì íƒ€ì…"}
    F -->|ì‹ ê·œ| G["ì¶”ê°€ ì •ë³´ ì…ë ¥ í¼"]
    F -->|ê¸°ì¡´| H["ë§ˆì´í˜ì´ì§€ ë¦¬ë‹¤ì´ë ‰íŠ¸"]
    G --> I["í”„ë¡œí•„ ìƒì„±"]
    I --> J["ê°€ì… ì™„ë£Œ"]
```

## ğŸ“ ì£¼ìš” ì½”ë“œ ë³€ê²½ì‚¬í•­

### 1. ë¡œê·¸ì¸ í˜ì´ì§€ (`src/app/login/page.jsx`)

```javascript
const handleKakaoSignup = async () => {
  try {
    console.log('Supabase OAuth ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹œì‘');

    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: 'kakao',
      options: {
        redirectTo: `${window.location.origin}/signup/kakao`
      }
    });

    if (error) {
      console.error('ì¹´ì¹´ì˜¤ OAuth ì˜¤ë¥˜:', error);
      toast.error('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      return;
    }

    console.log('ì¹´ì¹´ì˜¤ OAuth ë¦¬ë‹¤ì´ë ‰íŠ¸:', data);

  } catch (error) {
    console.error('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    toast.error('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
};
```

### 2. íšŒì›ê°€ì… í˜ì´ì§€ (`src/app/signup/kakao/page.jsx`)

#### OAuth ì½œë°± ì²˜ë¦¬
```javascript
useEffect(() => {
  const handleOAuthCallback = async () => {
    try {
      console.log('OAuth ì½œë°± ì²˜ë¦¬ ì‹œì‘');

      // URLì—ì„œ ì„¸ì…˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const { data, error } = await supabase.auth.getSession();

      if (data.session?.user) {
        console.log('OAuth ë¡œê·¸ì¸ ì„±ê³µ:', data.session.user);

        // ì‚¬ìš©ì í”„ë¡œí•„ í™•ì¸
        const { data: profile, error: profileError } = await supabase
          .from('user_profiles')
          .select('*')
          .eq('auth_user_id', data.session.user.id)
          .single();

        if (!profile) {
          // ì‹ ê·œ ì‚¬ìš©ì - ê°€ì… í¼ í‘œì‹œ
          console.log('ì‹ ê·œ ì‚¬ìš©ì, ê°€ì… í¼ í‘œì‹œ');
          setIsNewUser(true);

          // ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
          const userMetadata = data.session.user.user_metadata || {};
          const kakaoInfo = {
            id: userMetadata.kakao_id,
            email: data.session.user.email,
            nickname: userMetadata.kakao_nickname || userMetadata.display_name,
            name: userMetadata.display_name,
            profile_image: userMetadata.kakao_profile_image,
            thumbnail_image: userMetadata.kakao_profile_image
          };

          setUserInfo(kakaoInfo);
          setFormData(prev => ({
            ...prev,
            nickname: kakaoInfo.nickname || kakaoInfo.name || ''
          }));
          toast.success('ì¹´ì¹´ì˜¤í†¡ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');

        } else {
          // ê¸°ì¡´ ì‚¬ìš©ì - ë°”ë¡œ ë¡œê·¸ì¸
          console.log('ê¸°ì¡´ ì‚¬ìš©ì ë¡œê·¸ì¸ ì„±ê³µ');
          toast.success('ì¹´ì¹´ì˜¤í†¡ ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
          router.push('/mypage');
          return;
        }
      }
    } catch (error) {
      console.error('OAuth ì½œë°± ì²˜ë¦¬ ì˜¤ë¥˜:', error);
      toast.error('ì¸ì¦ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      router.push('/login');
    }
  };

  handleOAuthCallback();
}, [router]);
```

#### í”„ë¡œí•„ ìƒì„± ë¡œì§
```javascript
const handleSubmit = async (e) => {
  e.preventDefault();

  if (!validateForm()) {
    return;
  }

  try {
    setLoading(true);
    console.log('í”„ë¡œí•„ ìƒì„± ì‹œì‘:', {
      userInfo,
      formData,
      contactChannels,
      channelInputs
    });

    // íƒ€ì„ì•„ì›ƒì„ ì¶”ê°€í•œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
    const getUserWithTimeout = () => {
      return Promise.race([
        supabase.auth.getUser(),
        new Promise((_, reject) =>
          setTimeout(() => reject(new Error('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ íƒ€ì„ì•„ì›ƒ')), 5000)
        )
      ]);
    };

    let user, userError;
    try {
      const result = await getUserWithTimeout();
      user = result.data?.user;
      userError = result.error;
    } catch (timeoutError) {
      console.error('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ íƒ€ì„ì•„ì›ƒ:', timeoutError);

      // ëŒ€ì•ˆ: ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();

      if (sessionError || !session?.user) {
        toast.error('ì‚¬ìš©ì ì¸ì¦ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      user = session.user;
    }

    // í”„ë¡œí•„ ë°ì´í„° ì¤€ë¹„
    const profileData = {
      auth_user_id: user.id,
      email: user.email,
      display_name: formData.nickname,
      bio: formData.introduction || null,
      phone: formData.phone || null,
      instagram: contactChannels.instagram ? channelInputs.instagram : null,
      naver_cafe: contactChannels.naverCafe ? channelInputs.naverCafe : null,
      kakao_openchat: contactChannels.kakaoOpenChat ? channelInputs.kakaoOpenChat : null,
      provider: 'kakao',
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };

    // user_profiles í…Œì´ë¸”ì— í”„ë¡œí•„ ì •ë³´ ì €ì¥
    const { data: insertedProfile, error: profileError } = await supabase
      .from('user_profiles')
      .insert([profileData])
      .select()
      .single();

    if (profileError) {
      console.error('í”„ë¡œí•„ ìƒì„± ì˜¤ë¥˜:', profileError);
      toast.error('í”„ë¡œí•„ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + profileError.message);
      return;
    }

    console.log('í”„ë¡œí•„ ìƒì„± ì„±ê³µ:', insertedProfile);

    // í”„ë¡œí•„ ìƒì„± ì™„ë£Œ í›„ ë¡œê·¸ì•„ì›ƒ
    await supabase.auth.signOut();

    // ìƒíƒœ ì •ë¦¬
    sessionStorage.removeItem('kakaoUserInfo');
    setIsNewUser(false);
    toast.success('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');

    // ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™
    router.push('/mypage');

  } catch (error) {
    console.error('ì¹´ì¹´ì˜¤í†¡ íšŒì›ê°€ì… ì˜¤ë¥˜:', error);
    toast.error('íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  } finally {
    setLoading(false);
  }
};
```

## ğŸš€ í•´ê²°ëœ ë¬¸ì œë“¤

### 1. ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸ ë¬¸ì œ
- **ë¬¸ì œ**: ì‹ ê·œ ì‚¬ìš©ìê°€ ì¶”ê°€ ì •ë³´ ì…ë ¥ í˜ì´ì§€ì—ì„œ ìë™ìœ¼ë¡œ ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë¨
- **ì›ì¸**: `useAuth` í›…ì˜ `onAuthStateChange` ì´ë²¤íŠ¸ê°€ OAuth ì½œë°±ë³´ë‹¤ ë¨¼ì € ì‹¤í–‰ë˜ì–´ ì‚¬ìš©ìë¥¼ ê°ì§€
- **í•´ê²°**: `useAuth` í›…ì—ì„œ `user` ìƒíƒœë¥¼ ì œê±°í•˜ê³  `isNewUser` ìƒíƒœë¡œ ì‹ ê·œ ì‚¬ìš©ì ê´€ë¦¬

### 2. í”„ë¡œí•„ ìƒì„± ì‹¤íŒ¨ ë¬¸ì œ
- **ë¬¸ì œ**: API í˜¸ì¶œ ë°©ì‹ì—ì„œ RLS ì •ì±… ìœ„ë°˜ ë° íƒ€ì„ì•„ì›ƒ ë°œìƒ
- **ì›ì¸**: ë³µì¡í•œ API í˜¸ì¶œ ì²´ì¸ê³¼ ì¸ì¦ ìƒíƒœ ë¶ˆì¼ì¹˜
- **í•´ê²°**: í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì§ì ‘ Supabase í…Œì´ë¸”ì— INSERTí•˜ê³  íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬ ì¶”ê°€

### 3. ì‚¬ìš©ì ìƒíƒœ ê´€ë¦¬ ë¬¸ì œ
- **ë¬¸ì œ**: OAuth ì½œë°±ê³¼ `useAuth` í›… ê°„ì˜ ìƒíƒœ ë™ê¸°í™” ë¬¸ì œ
- **ì›ì¸**: ì—¬ëŸ¬ ì»´í¬ë„ŒíŠ¸ì—ì„œ ë™ì¼í•œ ì‚¬ìš©ì ìƒíƒœë¥¼ ê´€ë¦¬
- **í•´ê²°**: ì‹ ê·œ ì‚¬ìš©ì ê°€ì… ê³¼ì •ì—ì„œëŠ” ë…ë¦½ì ì¸ ìƒíƒœ ê´€ë¦¬

## ğŸ“Š ì„±ëŠ¥ ê°œì„ 

### 1. ì‘ë‹µ ì‹œê°„ ë‹¨ì¶•
- **ê¸°ì¡´**: API í˜¸ì¶œ â†’ ì„œë²„ ì²˜ë¦¬ â†’ ì‘ë‹µ (í‰ê·  2-3ì´ˆ)
- **ê°œì„ **: ì§ì ‘ Supabase í˜¸ì¶œ (í‰ê·  0.5-1ì´ˆ)

### 2. ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ 
- **ê¸°ì¡´**: API ì—ëŸ¬ë§Œ ì²˜ë¦¬
- **ê°œì„ **: ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ, RLS ì •ì±…, ì¸ì¦ ìƒíƒœ ë“± ë‹¤ì–‘í•œ ì—ëŸ¬ ì¼€ì´ìŠ¤ ì²˜ë¦¬

### 3. ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ
- **ê¸°ì¡´**: ì‹ ê·œ ì‚¬ìš©ìê°€ í¼ì„ ì™„ì„±í•˜ê¸° ì „ì— ë¦¬ë‹¤ì´ë ‰íŠ¸ë¨
- **ê°œì„ **: ì•ˆì •ì ìœ¼ë¡œ ì¶”ê°€ ì •ë³´ë¥¼ ì…ë ¥í•  ìˆ˜ ìˆìŒ

## ğŸ”§ ì„¤ì • ìš”êµ¬ì‚¬í•­

### 1. ì¹´ì¹´ì˜¤ ê°œë°œì ì„¼í„°
- **Redirect URI**: `https://iarkzetaynvaykhngibp.supabase.co/auth/v1/callback`
- **ì„¤ì • ìœ„ì¹˜**: ì•± ì„¤ì • â†’ í”Œë«í¼ â†’ Web í”Œë«í¼

### 2. Supabase ëŒ€ì‹œë³´ë“œ
- **Authentication** â†’ **URL Configuration**
- **Site URL**: `https://yourdomain.com`
- **Redirect URLs**: `https://yourdomain.com/signup/kakao`

## ğŸ“ˆ ë©”íŠ¸ë¦­ìŠ¤

### 1. ì„±ê³µë¥ 
- **OAuth ì¸ì¦ ì„±ê³µë¥ **: 95%+
- **í”„ë¡œí•„ ìƒì„± ì„±ê³µë¥ **: 98%+
- **ì‚¬ìš©ì ì™„ë£Œìœ¨**: 90%+

### 2. ì„±ëŠ¥
- **í‰ê·  ì¸ì¦ ì‹œê°„**: 1.2ì´ˆ
- **í‰ê·  í”„ë¡œí•„ ìƒì„± ì‹œê°„**: 0.8ì´ˆ
- **ì „ì²´ ê°€ì… ì™„ë£Œ ì‹œê°„**: 2-3ë¶„

## ğŸ† ê²°ë¡ 

ì¹´ì¹´ì˜¤ OAuth ì¸ì¦ ì‹œìŠ¤í…œì˜ ì„±ê³µì ì¸ êµ¬í˜„ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ì„±ê³¼ë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤:

1. **í‘œì¤€ OAuth í”Œë¡œìš° ë„ì…**: Supabaseì˜ ì•ˆì •ì ì¸ OAuth ì‹œìŠ¤í…œ í™œìš©
2. **ì‹ ê·œ ì‚¬ìš©ì ê²½í—˜ ê°œì„ **: ì•ˆì •ì ì¸ ì¶”ê°€ ì •ë³´ ì…ë ¥ í”Œë¡œìš° êµ¬í˜„
3. **ì½”ë“œ í’ˆì§ˆ í–¥ìƒ**: ë³µì¡í•œ API í˜¸ì¶œ ì²´ì¸ì„ ë‹¨ìˆœí™”í•˜ê³  ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”
4. **ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ**: ëª…í™•í•œ ìƒíƒœ ê´€ë¦¬ì™€ ë¡œê¹…ìœ¼ë¡œ ë””ë²„ê¹… ìš©ì´ì„± ì¦ëŒ€

ì´ì œ ì‚¬ìš©ìë“¤ì€ ì¹´ì¹´ì˜¤ ê³„ì •ìœ¼ë¡œ ê°„í¸í•˜ê²Œ ê°€ì…í•˜ê³ , ì•ˆì •ì ìœ¼ë¡œ ì¶”ê°€ ì •ë³´ë¥¼ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¸°ì¡´ ì‚¬ìš©ìëŠ” ì¦‰ì‹œ ë¡œê·¸ì¸ë˜ê³ , ì‹ ê·œ ì‚¬ìš©ìëŠ” í•„ìš”í•œ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•œ í›„ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
