# 2025년 9월 22일 - 문의하기 시스템 구현 및 작성자용 포스트 관리 기능 개발

## 📋 작업 개요

### 주요 작업 내용
1. **문의하기 시스템 구현**: 포스트 작성자가 아닌 사용자를 위한 문의 기능 개발
2. **작성자용 포스트 상세 페이지**: 탭 기반 UI로 게시물과 지원자 관리 기능 구현
3. **지도 연동 길찾기**: 네이버맵과 카카오맵 길찾기 기능 구현
4. **UI/UX 개선**: 모바일 앱 디자인에 맞는 인터페이스 구현

### 작업 시간
- **시작**: 2025년 9월 22일 오전
- **완료**: 2025년 9월 22일 오후
- **총 소요 시간**: 약 8시간

---

## 🎯 주요 기능

### 1. 문의하기 시스템

#### 1.1 문의하기 페이지 (`/posts/[id]/inquiry`)
- **디자인**: 첨부된 이미지와 동일한 UI 구현
- **지원자 정보 표시**: 현재 로그인한 사용자의 프로필 정보 표시
- **메시지 입력**: 1000자 제한의 텍스트 영역
- **문의 전송**: API를 통한 문의 데이터 저장

#### 1.2 문의하기 API (`/api/inquiries`)
- **POST**: 새 문의 생성
- **GET**: 사용자의 문의 목록 조회
- **인증 확인**: 로그인한 사용자만 접근 가능
- **자기 게시물 제한**: 자신의 게시물에는 문의 불가
- **중복 문의 방지**: 동일한 게시물에 중복 문의 불가
- **데이터 검증**: 필수 필드 확인

#### 1.3 데이터베이스 스키마
기존 `applications` 테이블을 활용하여 문의 기능을 구현했습니다.

```sql
-- 기존 applications 테이블 활용
-- posts 테이블의 status 컬럼에 CHECK 제약조건 추가
ALTER TABLE posts
ADD CONSTRAINT IF NOT EXISTS check_posts_status
CHECK (status IN ('active', 'completed', 'cancelled'));

-- posts 테이블에 completed_at 컬럼 추가
ALTER TABLE posts
ADD COLUMN IF NOT EXISTS completed_at TIMESTAMP WITH TIME ZONE;
```

### 2. 작성자용 포스트 상세 페이지

#### 2.1 탭 기반 UI 구성
- **게시물 탭**: 기존 포스트 상세 정보 표시
- **지원자 탭**: 지원자 목록과 개수 표시 (예: "지원자 2")
- **헤더**: "작성한 게시물" 제목으로 변경

#### 2.2 지원자 목록 화면
- **지원자 카드**: 이름, 연락처, 지원 시간, 메시지 미리보기
- **전체보기 버튼**: 클릭 시 상세 모달 표시
- **연락 기능**: 전화하기/문자하기 버튼
- **빈 상태**: 지원자가 없을 때 안내 메시지

#### 2.3 지원자 상세 모달
- **전체 메시지**: 지원자의 완전한 문의 내용 표시
- **연락처 정보**: 이름과 전화번호 표시
- **연락 버튼**: 전화하기/문자하기 기능

#### 2.4 모집 완료 기능
- **모집 완료 버튼**: 하단 고정 노란색 버튼
- **완료 후 상태**: "모집이 종료되어 문의자 정보를 확인할 수 없습니다" 메시지
- **API 연동**: `/api/posts/[id]/complete` 엔드포인트

### 3. 지도 연동 길찾기

#### 3.1 네이버맵 길찾기
- **좌표 기반**: posts 테이블의 위경도 정보 활용
- **URL 형식**: `https://map.naver.com/p/directions/{출발지경도},{출발지위도},{출발지명}/{도착지경도},{도착지위도},{도착지명}/-/car`
- **폴백 메커니즘**: 좌표가 없을 경우 검색 기반으로 대체

#### 3.2 카카오맵 길찾기
- **주소 기반**: 출발지와 도착지를 직접 지정
- **URL 형식**: `https://map.kakao.com/?sName={출발지}&eName={도착지}`
- **간단한 형식**: 주소만으로도 정확한 길찾기 실행

### 4. UI/UX 개선

#### 4.1 모바일 앱 디자인
- **상태바 제거**: 실제 모바일 앱처럼 시스템 상태바 제거
- **이미지 인디케이터 제거**: 한 장 이미지에 맞게 페이지 인디케이터 제거
- **고정 하단 버튼**: 모바일 앱 스타일의 하단 고정 버튼

#### 4.2 조건부 UI 표시
- **작성자인 경우**: 탭 UI + 모집 완료 버튼
- **일반 사용자인 경우**: 기존 문의하기 버튼 + 즐겨찾기

---

## 🔧 기술적 구현

### 1. 파일 구조
```
src/app/posts/[id]/
├── page.jsx                    # 포스트 상세 페이지 (작성자/일반 사용자 구분)
├── inquiry/
│   └── page.jsx               # 문의하기 페이지
└── complete/
    └── route.js               # 모집 완료 API

src/app/api/
├── inquiries/
│   └── route.js               # 문의하기 API
└── posts/[id]/complete/
    └── route.js               # 모집 완료 API

sql/
├── 20250922-01_create_inquiries_table.sql
└── 20250922-02_add_post_status_columns.sql
```

### 2. 주요 상태 관리
```javascript
// 포스트 상세 페이지
const [isOwner, setIsOwner] = useState(false);
const [activeTab, setActiveTab] = useState('post');
const [applicants, setApplicants] = useState([]);
const [selectedApplicant, setSelectedApplicant] = useState(null);
const [showApplicantModal, setShowApplicantModal] = useState(false);
const [isRecruitmentComplete, setIsRecruitmentComplete] = useState(false);
```

### 3. 작성자 판단 로직
```javascript
useEffect(() => {
  if (user && post) {
    const isOwnerCheck = user.id === post.user_id;
    setIsOwner(isOwnerCheck);
  }
}, [user, post]);
```

### 4. 지도 연동 함수
```javascript
const handleNaverMap = () => {
  const startLat = post.departure_latitude || post.departure_lat;
  const startLng = post.departure_longitude || post.departure_lng;
  const endLat = post.arrival_latitude || post.arrival_lat;
  const endLng = post.arrival_longitude || post.arrival_lng;

  if (startLat && startLng && endLat && endLng) {
    const url = `https://map.naver.com/p/directions/${startLng},${startLat},${encodeURIComponent(post.departure_address)}/${endLng},${endLat},${encodeURIComponent(post.arrival_address)}/-/car`;
    window.open(url, '_blank');
  }
};
```

---

## 🎨 UI/UX 개선사항

### 1. 모바일 앱 디자인 적용
- **상태바 제거**: 불필요한 시계, 신호 아이콘 제거
- **이미지 최적화**: 한 장 이미지에 맞게 페이지 인디케이터 제거
- **하단 고정 버튼**: 모바일 앱 스타일의 액션 버튼

### 2. 조건부 UI 렌더링
- **작성자용 UI**: 탭 기반 인터페이스, 지원자 관리 기능
- **일반 사용자용 UI**: 문의하기 버튼, 즐겨찾기 기능

### 3. 반응형 디자인
- **모바일 우선**: 모바일 앱 디자인을 기준으로 구현
- **터치 친화적**: 버튼 크기와 간격을 터치에 최적화

---

## 🐛 해결된 문제들

### 1. 작성자 판단 문제
- **문제**: `useAuth` 훅과 `supabase.auth.getUser()` 혼용으로 인한 일관성 부족
- **해결**: `useAuth` 훅을 통일하여 사용자 정보 관리

### 2. 작성일 표시 문제
- **문제**: `deadline`을 작성일로 표시
- **해결**: `created_at`을 작성일로 변경

### 3. 네이버지도 링크 문제
- **문제**: 주소 기반 링크가 작동하지 않음
- **해결**: posts 테이블의 위경도 정보를 활용한 좌표 기반 링크 구현

### 4. UI 레이아웃 문제
- **문제**: 문의하기 버튼이 폼 밖으로 나가는 문제
- **해결**: `fixed` 위치를 `sticky`로 변경하여 레이아웃 내부에 배치

---

## 📊 성능 최적화

### 1. 조건부 렌더링
- **탭 기반 UI**: 필요한 컴포넌트만 렌더링
- **모달 관리**: 상태에 따른 모달 표시/숨김

### 2. API 최적화
- **지원자 목록**: 작성자인 경우에만 조회
- **좌표 활용**: 데이터베이스에 저장된 정확한 좌표 사용

### 3. 사용자 경험
- **로딩 상태**: 적절한 로딩 표시
- **오류 처리**: 각종 오류 상황에 대한 적절한 처리

---

## 🔒 보안 및 데이터 무결성

### 1. 인증 및 권한
- **문의 생성**: 로그인한 사용자만 가능
- **자기 게시물 제한**: 자신의 게시물에는 문의 불가
- **작성자 확인**: 포스트 작성자만 지원자 목록 조회 가능

### 2. 데이터 검증
- **필수 필드**: 문의 메시지 등 필수 필드 검증
- **입력 제한**: 메시지 1000자 제한

### 3. RLS 정책
- **inquiries 테이블**: 사용자별 데이터 접근 권한 관리
- **posts 테이블**: 작성자만 모집 완료 처리 가능

---

## 🚀 향후 개선사항

### 1. 지오코딩 API 연동
- **네이버 지오코딩 API**: 정확한 주소-좌표 변환
- **캐싱 시스템**: 성능 최적화를 위한 좌표 캐싱

### 2. 알림 시스템
- **문의 알림**: 작성자에게 새 문의 알림
- **상태 변경 알림**: 모집 완료 시 지원자에게 알림

### 3. 관리자 기능
- **문의 관리**: 관리자용 문의 목록 및 처리
- **통계 대시보드**: 문의 현황 및 통계

---

## 📝 개발 과정

### 1. 문의하기 시스템 구현
1. 문의하기 페이지 UI 구현
2. 문의하기 API 개발
3. 데이터베이스 스키마 설계
4. 권한 및 보안 정책 적용

### 2. 작성자용 포스트 관리
1. 탭 기반 UI 구현
2. 지원자 목록 조회 기능
3. 지원자 상세 모달 구현
4. 모집 완료 기능 개발

### 3. 지도 연동 기능
1. 네이버맵 길찾기 구현
2. 카카오맵 길찾기 구현
3. 좌표 기반 링크 최적화
4. 폴백 메커니즘 구현

### 4. UI/UX 개선
1. 모바일 앱 디자인 적용
2. 조건부 UI 구현
3. 반응형 디자인 최적화
4. 사용자 경험 개선

---

## 🎯 결론

오늘 작업을 통해 완전한 문의하기 시스템과 작성자용 포스트 관리 기능을 구현했습니다. 사용자는 이제 다른 사람의 포스트에 문의를 남길 수 있고, 작성자는 자신의 포스트에 대한 지원자들을 체계적으로 관리할 수 있습니다. 또한 지도 연동을 통해 실제 이동 경로를 쉽게 확인할 수 있는 기능도 추가되었습니다.

모든 기능이 모바일 앱 디자인에 맞게 구현되어 사용자 경험이 크게 향상되었으며, 보안과 데이터 무결성도 철저히 고려하여 안정적인 시스템을 구축했습니다.

---

## 📚 참고 자료

- [네이버클라우드 Maps Directions API](https://api.ncloud-docs.com/docs/ai-naver-mapsdirections-driving)
- [카카오맵 길찾기 API](https://apis.map.kakao.com/web/sample/basicMarkerImage/)
- [Supabase RLS 정책](https://supabase.com/docs/guides/auth/row-level-security)
- [Next.js App Router](https://nextjs.org/docs/app)
- [Tailwind CSS](https://tailwindcss.com/docs)
